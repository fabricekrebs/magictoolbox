<!-- History Sidebar Include -->
<!-- Use with: {% include 'tools/includes/history_sidebar.html' with tool_name=tool.name %} -->

<div class="card shadow-sm sticky-top" style="top: 1rem;">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent History</h6>
        <button 
            type="button" 
            class="btn btn-sm btn-outline-secondary" 
            id="refreshHistoryBtn"
            title="Refresh history"
        >
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
    <div class="card-body p-0">
        <!-- Loading State -->
        <div id="historyLoading" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted small mt-2 mb-0">Loading history...</p>
        </div>
        
        <!-- Empty State -->
        <div id="historyEmpty" class="text-center py-4" style="display: none;">
            <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
            <p class="text-muted small mb-0">No history yet</p>
        </div>
        
        <!-- History List -->
        <div id="historyList" class="list-group list-group-flush" style="display: none;">
            <!-- History items will be inserted here -->
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this execution? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
// History management
let currentToolName = '{{ tool_name }}';
let deleteExecutionId = null;

// Format time ago
function timeAgo(dateString) {
    const date = new Date(dateString);
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

// Get status badge class
function getStatusBadgeClass(status) {
    switch (status) {
        case 'completed': return 'bg-success';
        case 'failed': return 'bg-danger';
        case 'processing': return 'bg-primary';
        case 'pending': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

// Load history from API
async function loadHistory() {
    const loading = document.getElementById('historyLoading');
    const empty = document.getElementById('historyEmpty');
    const list = document.getElementById('historyList');
    
    loading.style.display = 'block';
    empty.style.display = 'none';
    list.style.display = 'none';
    
    try {
        const response = await fetch(`/api/v1/executions/?tool_name=${currentToolName}&limit=10`);
        if (!response.ok) throw new Error('Failed to load history');
        
        const data = await response.json();
        const executions = data.results || [];
        
        loading.style.display = 'none';
        
        if (executions.length === 0) {
            empty.style.display = 'block';
            return;
        }
        
        // Render history items
        list.innerHTML = executions.map(exec => `
            <div class="list-group-item list-group-item-action p-2">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="flex-grow-1" style="min-width: 0;">
                        <p class="mb-0 small text-truncate" title="${exec.input_filename}">
                            <i class="bi bi-file-earmark"></i> ${exec.input_filename}
                        </p>
                        <p class="mb-0 text-muted" style="font-size: 0.75rem;">
                            ${timeAgo(exec.created_at)}
                        </p>
                    </div>
                    <span class="badge ${getStatusBadgeClass(exec.status)} ms-2">
                        ${exec.status}
                    </span>
                </div>
                <div class="d-flex gap-1">
                    ${exec.status === 'completed' ? `
                        <a href="/api/v1/executions/${exec.id}/download/" 
                           class="btn btn-sm btn-outline-success flex-fill"
                           title="Download result">
                            <i class="bi bi-download"></i>
                        </a>
                    ` : ''}
                    <button 
                        class="btn btn-sm btn-outline-danger ${exec.status === 'completed' ? '' : 'flex-fill'}"
                        onclick="confirmDelete('${exec.id}')"
                        title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        list.style.display = 'block';
        
    } catch (error) {
        console.error('Error loading history:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
    }
}

// Confirm delete
function confirmDelete(executionId) {
    deleteExecutionId = executionId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Delete execution
async function deleteExecution() {
    if (!deleteExecutionId) return;
    
    try {
        const response = await fetch(`/api/v1/executions/${deleteExecutionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (!response.ok) throw new Error('Delete failed');
        
        // Close modal and reload history
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();
        
        loadHistory();
        
    } catch (error) {
        console.error('Error deleting execution:', error);
        alert('Failed to delete execution. Please try again.');
    }
}

// Event listeners
document.getElementById('refreshHistoryBtn')?.addEventListener('click', loadHistory);
document.getElementById('confirmDeleteBtn')?.addEventListener('click', deleteExecution);

// Load history on page load
document.addEventListener('DOMContentLoaded', () => {
    if (currentToolName) {
        loadHistory();
    }
});
</script>
