{% extends 'base.html' %}
{% load static %}

{% block title %}Video Rotation - MagicToolbox{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Tool Header -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tools:tool_list' %}">Tools</a></li>
          <li class="breadcrumb-item active" aria-current="page">Video Rotation</li>
        </ol>
      </nav>
      <h1 class="display-5 fw-bold">
        <i class="bi bi-arrow-clockwise text-primary me-2"></i>
        Video Rotation
      </h1>
      <p class="lead text-muted">Rotate your videos by 90° clockwise, 90° counter-clockwise, or 180°.</p>
    </div>
  </div>

  <div class="row">
    <!-- Tool Form -->
    <div class="col-lg-8">
      <!-- Step 1: Upload Video -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-upload me-2"></i>Step 1: Upload Video
          </h5>
        </div>
        <div class="card-body">
          <form id="videoUploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- File Upload -->
            <div class="mb-3">
              <label for="videoFile" class="form-label fw-bold">
                <i class="bi bi-file-earmark-play me-2"></i>Select Video File
              </label>
              <input type="file" class="form-control form-control-lg" id="videoFile" name="file" 
                     accept=".mp4,.avi,.mov,.mkv,.webm,.flv,.wmv,.m4v,.mpg,.mpeg,.3gp" required>
              <div class="form-text">
                Supported formats: MP4, AVI, MOV, MKV, WEBM, FLV, WMV, M4V, MPG, MPEG, 3GP
                <br>
                Maximum file size: 500 MB
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                <i class="bi bi-cloud-upload me-2"></i>Upload Video
              </button>
            </div>
          </form>

          <!-- Upload Progress -->
          <div id="uploadProgress" class="mt-3" style="display: none;">
            <div class="alert alert-info">
              <i class="bi bi-hourglass-split me-2"></i>
              <span id="uploadStatus">Uploading video...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Select and Rotate Video -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-arrow-repeat me-2"></i>Step 2: Select & Rotate Video
          </h5>
        </div>
        <div class="card-body">
          <!-- Refresh Button -->
          <div class="mb-3 d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Your Uploaded Videos</h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="refreshVideosBtn">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
          </div>

          <!-- Video List -->
          <div id="videoList" class="mb-4">
            <div class="text-center text-muted py-4">
              <i class="bi bi-hourglass-split fs-3"></i>
              <p class="mt-2">Loading videos...</p>
            </div>
          </div>

          <!-- Rotation Form (shown when video selected) -->
          <form id="videoRotationForm" style="display: none;">
            {% csrf_token %}
            <input type="hidden" id="selectedVideoId" name="video_id">
            
            <div class="alert alert-info">
              <strong>Selected:</strong> <span id="selectedVideoName">-</span>
            </div>

            <!-- Rotation Options -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="bi bi-arrow-repeat me-2"></i>Select Rotation
              </label>
              <div class="row g-3">
                <!-- 90° Clockwise -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check" name="rotation" id="rotation_90_cw" value="90_cw" required>
                  <label class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" for="rotation_90_cw">
                    <i class="bi bi-arrow-clockwise fs-1 mb-2"></i>
                    <strong>90° Clockwise</strong>
                    <small class="text-muted mt-1">Rotate right</small>
                  </label>
                </div>

                <!-- 90° Counter-Clockwise -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check" name="rotation" id="rotation_90_ccw" value="90_ccw">
                  <label class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" for="rotation_90_ccw">
                    <i class="bi bi-arrow-counterclockwise fs-1 mb-2"></i>
                    <strong>90° Counter-CW</strong>
                    <small class="text-muted mt-1">Rotate left</small>
                  </label>
                </div>

                <!-- 180° -->
                <div class="col-md-4">
                  <input type="radio" class="btn-check" name="rotation" id="rotation_180" value="180">
                  <label class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" for="rotation_180">
                    <i class="bi bi-arrow-repeat fs-1 mb-2"></i>
                    <strong>180°</strong>
                    <small class="text-muted mt-1">Flip upside down</small>
                  </label>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success btn-lg" id="rotateBtn">
                <i class="bi bi-play-circle me-2"></i>Rotate Video
              </button>
            </div>
          </form>

          <!-- Progress Section (hidden by default) -->
          <div id="progressSection" class="mt-4" style="display: none;">
            <div class="alert alert-info">
              <h6 class="alert-heading">
                <i class="bi bi-hourglass-split me-2"></i>Processing Video
              </h6>
              <p class="mb-2">Please wait while we rotate your video...</p>
              <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" 
                     id="progressBar"
                     style="width: 0%"
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                  <span id="progressText">0%</span>
                </div>
              </div>
              <small class="text-muted mt-2 d-block" id="progressMessage">Uploading video...</small>
            </div>
          </div>

          <!-- Result Section (hidden by default) -->
          <div id="resultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Success!
              </h5>
              <p class="mb-0">Your video has been rotated successfully.</p>
            </div>
            <div class="d-grid gap-2">
              <a href="#" id="downloadBtn" class="btn btn-success btn-lg" download>
                <i class="bi bi-download me-2"></i>Download Rotated Video
              </a>
              <button type="button" class="btn btn-outline-primary" id="resetBtn">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Rotate Another Video
              </button>
            </div>
          </div>

          <!-- Error Section (hidden by default) -->
          <div id="errorSection" class="mt-4" style="display: none;">
            <div class="alert alert-danger" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>Error
              </h5>
              <p class="mb-0" id="errorMessage"></p>
            </div>
            <button type="button" class="btn btn-outline-primary" id="retryBtn">
              <i class="bi bi-arrow-counterclockwise me-2"></i>Try Again
            </button>
          </div>
        </div>
      </div>

      <!-- Step 3: Rotated Videos History -->
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>Step 3: Your Rotated Videos
          </h5>
        </div>
        <div class="card-body">
          <!-- Refresh Button -->
          <div class="mb-3 d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Completed Rotations</h6>
            <button type="button" class="btn btn-sm btn-outline-info" id="refreshHistoryBtn">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
          </div>

          <!-- History List -->
          <div id="historyList">
            <div class="text-center text-muted py-4">
              <i class="bi bi-hourglass-split fs-3"></i>
              <p class="mt-2">Loading history...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tool Information -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>Tool Information
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="mb-3">
              <strong><i class="bi bi-file-earmark-check me-2"></i>Supported Formats:</strong>
              <div class="mt-2">
                <span class="badge bg-secondary me-1">MP4</span>
                <span class="badge bg-secondary me-1">AVI</span>
                <span class="badge bg-secondary me-1">MOV</span>
                <span class="badge bg-secondary me-1">MKV</span>
                <span class="badge bg-secondary me-1">WEBM</span>
                <span class="badge bg-secondary me-1">FLV</span>
              </div>
            </li>
            <li class="mb-3">
              <strong><i class="bi bi-hdd me-2"></i>Max File Size:</strong> 500 MB
            </li>
            <li class="mb-3">
              <strong><i class="bi bi-clock me-2"></i>Processing Time:</strong> 
              Depends on video size and quality
            </li>
            <li class="mb-3">
              <strong><i class="bi bi-shield-check me-2"></i>Quality:</strong> 
              Original quality preserved
            </li>
          </ul>
        </div>
      </div>

      <!-- How it Works -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-gear me-2"></i>How It Works
          </h6>
        </div>
        <div class="card-body">
          <ol class="small mb-0">
            <li class="mb-2"><strong>Step 1:</strong> Upload your video file to blob storage</li>
            <li class="mb-2"><strong>Step 2:</strong> Select a video from your uploaded videos</li>
            <li class="mb-2"><strong>Step 3:</strong> Choose the rotation angle (90° CW, 90° CCW, or 180°)</li>
            <li class="mb-2"><strong>Step 4:</strong> Click "Rotate Video" to start processing</li>
            <li class="mb-2"><strong>Step 5:</strong> Wait for the rotation to complete</li>
            <li class="mb-0"><strong>Step 6:</strong> Download your rotated video</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadForm = document.getElementById('videoUploadForm');
  const rotationForm = document.getElementById('videoRotationForm');
  const uploadBtn = document.getElementById('uploadBtn');
  const rotateBtn = document.getElementById('rotateBtn');
  const refreshVideosBtn = document.getElementById('refreshVideosBtn');
  const videoList = document.getElementById('videoList');
  const uploadProgress = document.getElementById('uploadProgress');
  const uploadStatus = document.getElementById('uploadStatus');
  const progressSection = document.getElementById('progressSection');
  const resultSection = document.getElementById('resultSection');
  const errorSection = document.getElementById('errorSection');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressMessage = document.getElementById('progressMessage');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const retryBtn = document.getElementById('retryBtn');
  const errorMessage = document.getElementById('errorMessage');
  const refreshHistoryBtn = document.getElementById('refreshHistoryBtn');
  const historyList = document.getElementById('historyList');

  let executionId = null;
  let statusCheckInterval = null;

  // Load videos and history on page load
  loadVideos();
  loadHistory();

  // Upload form submission
  uploadForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const fileInput = document.getElementById('videoFile');
    if (!fileInput.files[0]) {
      alert('Please select a video file');
      return;
    }

    uploadProgress.style.display = 'block';
    uploadBtn.disabled = true;
    uploadStatus.textContent = 'Uploading video...';

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
      const response = await fetch('/api/v1/tools/video-rotation/upload-video/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to upload video');
      }

      uploadStatus.textContent = 'Upload successful! Refreshing video list...';
      fileInput.value = '';
      
      // Reload video list
      setTimeout(() => {
        loadVideos();
        uploadProgress.style.display = 'none';
        uploadBtn.disabled = false;
      }, 1500);

    } catch (error) {
      uploadStatus.textContent = `Error: ${error.message}`;
      uploadBtn.disabled = false;
    }
  });

  // Refresh buttons
  refreshVideosBtn.addEventListener('click', loadVideos);
  refreshHistoryBtn.addEventListener('click', loadHistory);

  // Load videos function
  async function loadVideos() {
    videoList.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-hourglass-split fs-3"></i><p class="mt-2">Loading videos...</p></div>';

    try {
      const response = await fetch('/api/v1/tools/video-rotation/list-videos/');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load videos');
      }

      if (!data.videos || data.videos.length === 0) {
        videoList.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-2"></i>No videos uploaded yet. Upload a video in Step 1 above.</div>';
        return;
      }

      // Display videos
      let html = '<div class="list-group">';
      data.videos.forEach(video => {
        const uploadDate = video.uploaded_at ? new Date(video.uploaded_at).toLocaleString() : 'Unknown';
        const fileSize = formatFileSize(video.size);
        
        html += `
          <a href="#" class="list-group-item list-group-item-action video-item" data-video-id="${video.video_id}" data-video-name="${video.filename}">
            <div class="d-flex w-100 justify-content-between align-items-center">
              <div>
                <h6 class="mb-1"><i class="bi bi-file-earmark-play me-2"></i>${video.filename}</h6>
                <small class="text-muted">${fileSize} • ${uploadDate}</small>
              </div>
              <i class="bi bi-chevron-right"></i>
            </div>
          </a>
        `;
      });
      html += '</div>';
      videoList.innerHTML = html;

      // Add click handlers
      const videoItems = document.querySelectorAll('.video-item');
      console.log('Found video items:', videoItems.length);
      
      videoItems.forEach(item => {
        console.log('Attaching click handler to:', item.dataset.videoId);
        item.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Video item clicked!');
          selectVideo(this.dataset.videoId, this.dataset.videoName);
        });
      });

    } catch (error) {
      console.error('Error loading videos:', error);
      videoList.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>Error loading videos: ${error.message}</div>`;
    }
  }

  // Load rotation history
  async function loadHistory() {
    historyList.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-hourglass-split fs-3"></i><p class="mt-2">Loading history...</p></div>';

    try {
      const response = await fetch('/api/v1/executions/?tool_name=video-rotation&status=completed');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load history');
      }

      if (!data.results || data.results.length === 0) {
        historyList.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>No rotated videos yet. Complete a rotation in Step 2 above.</div>';
        return;
      }

      // Display history
      let html = '<div class="list-group">';
      data.results.forEach(exec => {
        const completedDate = exec.created_at ? new Date(exec.created_at).toLocaleString() : 'Unknown';
        const fileSize = exec.output_size ? formatFileSize(exec.output_size) : '';
        
        html += `
          <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1"><i class="bi bi-file-earmark-play me-2"></i>${exec.output_filename || exec.input_filename}</h6>
                <small class="text-muted">
                  ${fileSize ? fileSize + ' • ' : ''}${completedDate}
                </small>
              </div>
            </div>
            <div class="btn-group w-100" role="group">
              <button class="btn btn-sm btn-success download-history-btn" data-execution-id="${exec.id}" data-filename="${exec.output_filename || 'rotated_video.mp4'}">
                <i class="bi bi-download me-1"></i>Download
              </button>
              <button class="btn btn-sm btn-danger delete-history-btn" data-execution-id="${exec.id}" data-filename="${exec.output_filename || exec.input_filename}">
                <i class="bi bi-trash me-1"></i>Delete
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      historyList.innerHTML = html;

      // Add click handlers for download buttons
      document.querySelectorAll('.download-history-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const execId = this.dataset.executionId;
          const filename = this.dataset.filename;
          await downloadVideo(execId, filename);
        });
      });

      // Add click handlers for delete buttons
      document.querySelectorAll('.delete-history-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const execId = this.dataset.executionId;
          const filename = this.dataset.filename;
          
          if (confirm(`Are you sure you want to delete "${filename}"?`)) {
            await deleteVideo(execId);
          }
        });
      });

    } catch (error) {
      console.error('Error loading history:', error);
      historyList.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>Error loading history: ${error.message}</div>`;
    }
  }

  // Download video function
  async function downloadVideo(execId, filename) {
    try {
      const response = await fetch(`/api/v1/executions/${execId}/download/`, {
        credentials: 'same-origin'
      });
      
      if (!response.ok) {
        throw new Error('Download failed');
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (error) {
      alert('Failed to download video: ' + error.message);
    }
  }

  // Delete video function
  async function deleteVideo(execId) {
    try {
      const response = await fetch(`/api/v1/executions/${execId}/delete/`, {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      });
      
      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Delete failed');
      }
      
      // Reload history to remove the deleted item
      loadHistory();
      
      // Show success message
      alert('Video deleted successfully');
    } catch (error) {
      alert('Failed to delete video: ' + error.message);
    }
  }

  // Select video for rotation
  function selectVideo(videoId, videoName) {
    console.log('selectVideo called:', videoId, videoName);
    console.log('rotationForm element:', rotationForm);
    
    document.getElementById('selectedVideoId').value = videoId;
    document.getElementById('selectedVideoName').textContent = videoName;
    
    // Show the rotation form
    rotationForm.style.display = 'block';
    console.log('rotationForm display set to block');
    
    // Highlight selected video
    document.querySelectorAll('.video-item').forEach(item => {
      item.classList.remove('active');
    });
    const selectedItem = document.querySelector(`[data-video-id="${videoId}"]`);
    if (selectedItem) {
      selectedItem.classList.add('active');
    }
    
    // Scroll to rotation form
    rotationForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Rotation form submission
  rotationForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const videoId = document.getElementById('selectedVideoId').value;
    const rotationInput = document.querySelector('input[name="rotation"]:checked');

    if (!videoId) {
      alert('Please select a video');
      return;
    }

    if (!rotationInput) {
      alert('Please select a rotation angle');
      return;
    }

    // Hide sections
    resultSection.style.display = 'none';
    errorSection.style.display = 'none';
    progressSection.style.display = 'block';
    rotateBtn.disabled = true;

    const payload = {
      video_id: videoId,
      rotation: rotationInput.value
    };

    try {
      progressMessage.textContent = 'Starting video rotation...';
      updateProgress(10);

      const response = await fetch('/api/v1/tools/video-rotation/rotate-video/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to start rotation');
      }

      executionId = data.execution_id;
      progressMessage.textContent = 'Processing video rotation...';
      updateProgress(30);

      // Start polling for status
      startStatusPolling();

    } catch (error) {
      showError(error.message);
    }
  });

  function startStatusPolling() {
    statusCheckInterval = setInterval(checkStatus, 3000); // Check every 3 seconds
  }

  async function checkStatus() {
    try {
      const response = await fetch(`/api/v1/executions/${executionId}/status/`);
      const data = await response.json();

      if (data.status === 'completed') {
        clearInterval(statusCheckInterval);
        updateProgress(100);
        progressMessage.textContent = 'Rotation complete!';
        showSuccess(data);
      } else if (data.status === 'failed') {
        clearInterval(statusCheckInterval);
        throw new Error(data.error || 'Video rotation failed');
      } else if (data.status === 'processing') {
        updateProgress(Math.min(90, 30 + (Date.now() - startTime) / 1000));
        progressMessage.textContent = 'Rotating video with FFmpeg...';
      } else {
        // pending
        progressMessage.textContent = 'Waiting for processing to start...';
      }
    } catch (error) {
      clearInterval(statusCheckInterval);
      showError(error.message);
    }
  }

  let startTime = Date.now();

  function updateProgress(percent) {
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    progressText.textContent = Math.round(percent) + '%';
  }

  function showSuccess(data) {
    progressSection.style.display = 'none';
    resultSection.style.display = 'block';
    
    // Reload history to show the new rotated video
    loadHistory();
    
    // Set download button to trigger authenticated download
    const filename = data.outputFilename || 'rotated_video.mp4';
    
    downloadBtn.onclick = async function(e) {
      e.preventDefault();
      await downloadVideo(executionId, filename);
    };
  }

  function showError(message) {
    progressSection.style.display = 'none';
    errorSection.style.display = 'block';
    errorMessage.textContent = message;
    rotateBtn.disabled = false;
  }

  // Helper function to format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Reset form
  resetBtn.addEventListener('click', function() {
    rotationForm.reset();
    rotationForm.style.display = 'none';
    resultSection.style.display = 'none';
    rotateBtn.disabled = false;
    executionId = null;
    
    // Clear selection
    document.querySelectorAll('.video-item').forEach(item => {
      item.classList.remove('active');
    });
  });

  retryBtn.addEventListener('click', function() {
    errorSection.style.display = 'none';
    rotateBtn.disabled = false;
  });
});
</script>
{% endblock %}
