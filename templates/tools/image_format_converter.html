{% extends 'base.html' %}
{% load static crispy_forms_tags %}

{% block title %}{{ tool.display_name }} - MagicToolbox{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Tool Header -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tools:tool_list' %}">Tools</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ tool.display_name }}</li>
        </ol>
      </nav>
      <h1 class="display-5 fw-bold">
        <i class="bi bi-image text-primary me-2"></i>
        {{ tool.display_name }}
      </h1>
      <p class="lead text-muted">{{ tool.description }}</p>
    </div>
  </div>

  <div class="row">
    <!-- Tool Form -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-upload me-2"></i>Upload & Convert Image
          </h5>
        </div>
        <div class="card-body">
          <form id="imageConverterForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="imageFile" class="form-label">
                Select Image(s) 
                <span class="badge bg-info">NEW: Multiple files supported!</span>
              </label>
              <input type="file" class="form-control" id="imageFile" name="files[]" accept="image/*,.heic,.heif" multiple required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Select one or multiple images (max 50MB per file). Supports HEIC format!
              </div>
              <div id="fileList" class="mt-2"></div>
            </div>

            <div class="mb-3">
              <label for="outputFormat" class="form-label">Output Format</label>
              <select class="form-select" id="outputFormat" name="output_format" required>
                <option value="">Choose format...</option>
                <option value="jpg" selected>JPEG (.jpg) - Best for photos</option>
                <option value="png">PNG (.png) - Lossless, supports transparency</option>
                <option value="webp">WebP (.webp) - Modern format, great compression</option>
                <option value="gif">GIF (.gif) - Supports animation</option>
                <option value="bmp">BMP (.bmp) - Uncompressed</option>
                <option value="tiff">TIFF (.tiff) - High quality</option>
                <option value="ico">ICO (.ico) - Icon format</option>
                <option value="tga">TGA (.tga) - Targa format</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="quality" class="form-label">Quality <span class="text-muted">(for JPEG/WebP)</span></label>
              <div class="row align-items-center">
                <div class="col">
                  <input type="range" class="form-range" id="quality" name="quality" min="1" max="100" value="85">
                </div>
                <div class="col-auto">
                  <span class="badge bg-primary" id="qualityValue">85</span>
                </div>
              </div>
            </div>

            <div class="card bg-light mb-3">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-arrows-angle-expand me-2"></i>Resize Options <span class="text-muted small">(Optional)</span>
                </h6>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label for="width" class="form-label">Width (px)</label>
                    <input type="number" class="form-control" id="width" name="width" placeholder="Leave empty to keep original">
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="height" class="form-label">Height (px)</label>
                    <input type="number" class="form-control" id="height" name="height" placeholder="Leave empty to keep original">
                  </div>
                </div>
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  If only one dimension is specified, aspect ratio will be maintained
                </small>
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="convertBtn">
                <i class="bi bi-arrow-repeat me-2"></i>Convert Image
              </button>
            </div>
          </form>

          <!-- Progress Section -->
          <div id="progressSection" class="mt-4" style="display: none;">
            <div class="progress" style="height: 30px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                   role="progressbar" 
                   id="progressBar"
                   style="width: 0%">
                <span id="progressText">0%</span>
              </div>
            </div>
            <p class="text-center text-muted mt-2" id="progressMessage">Converting your image...</p>
          </div>

          <!-- Result Section -->
          <div id="resultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Conversion Successful!
              </h5>
              <p class="mb-0">Your image has been converted successfully.</p>
            </div>

            <!-- Image Comparison -->
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">Image Comparison</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <h6 class="text-center mb-3">Original Image</h6>
                    <div class="text-center border rounded p-2 bg-light">
                      <img id="originalImage" class="img-fluid rounded" style="max-height: 400px;" alt="Original">
                      <div class="mt-2">
                        <small class="text-muted" id="originalInfo"></small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-center mb-3">Converted Image</h6>
                    <div class="text-center border rounded p-2 bg-light">
                      <img id="convertedImage" class="img-fluid rounded" style="max-height: 400px;" alt="Converted">
                      <div class="mt-2">
                        <small class="text-muted" id="convertedInfo"></small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Download Button -->
            <div class="d-grid gap-2">
              <a href="#" id="downloadBtn" class="btn btn-success btn-lg" download>
                <i class="bi bi-download me-2"></i>Download Converted Image
              </a>
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Convert Another Image
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tool Information -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>Supported Formats
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6"><span class="badge bg-primary w-100">JPEG</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">PNG</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">WebP</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">GIF</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">BMP</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">TIFF</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">ICO</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">TGA</span></div>
            <div class="col-6"><span class="badge bg-success w-100">HEIC</span></div>
            <div class="col-6"><span class="badge bg-success w-100">HEIF</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">PPM</span></div>
            <div class="col-6"><span class="badge bg-primary w-100">PGM</span></div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>Usage Tips
          </h6>
        </div>
        <div class="card-body">
          <ul class="small mb-0">
            <li>Use JPEG for photos with smaller file sizes</li>
            <li>Use PNG for images with transparency or text</li>
            <li>WebP offers best compression for web use</li>
            <li>Quality setting affects JPEG and WebP only</li>
            <li>Resize images to reduce file size</li>
            <li>Maintain aspect ratio by specifying one dimension</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update quality value display
document.getElementById('quality').addEventListener('input', function(e) {
  document.getElementById('qualityValue').textContent = e.target.value;
});

// Show selected files list
const fileInput = document.getElementById('imageFile');
const fileListDiv = document.getElementById('fileList');

fileInput.addEventListener('change', function() {
  const files = Array.from(fileInput.files);
  if (files.length === 0) {
    fileListDiv.innerHTML = '';
    return;
  }

  fileListDiv.innerHTML = `
    <div class="alert alert-info">
      <i class="bi bi-files me-2"></i>
      <strong>${files.length}</strong> file${files.length > 1 ? 's' : ''} selected
      <ul class="mb-0 mt-2">
        ${files.map(file => `
          <li class="small">
            ${file.name} 
            <span class="text-muted">(${MagicToolbox.formatFileSize(file.size)})</span>
          </li>
        `).join('')}
      </ul>
    </div>
  `;
});

// Handle form submission
document.getElementById('imageConverterForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const fileInput = document.getElementById('imageFile');
  const files = Array.from(fileInput.files);
  
  if (files.length === 0) {
    MagicToolbox.showNotification('Please select at least one image file', 'error');
    return;
  }

  const formData = new FormData();
  
  // Append all files
  files.forEach(file => {
    formData.append('files[]', file);
  });
  
  // Append settings
  formData.append('output_format', document.getElementById('outputFormat').value);
  formData.append('quality', document.getElementById('quality').value);
  
  const width = document.getElementById('width').value;
  const height = document.getElementById('height').value;
  if (width) formData.append('width', width);
  if (height) formData.append('height', height);
  
  const convertBtn = document.getElementById('convertBtn');
  const progressSection = document.getElementById('progressSection');
  const resultSection = document.getElementById('resultSection');
  const progressMessage = document.getElementById('progressMessage');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  // Update progress message based on file count
  if (files.length === 1) {
    progressMessage.textContent = 'Converting your image...';
  } else {
    progressMessage.textContent = `Converting image 1 of ${files.length}...`;
  }
  
  // Show progress
  convertBtn.disabled = true;
  progressSection.style.display = 'block';
  resultSection.style.display = 'none';
  
  // Reset progress
  progressBar.style.width = '0%';
  progressText.textContent = '0%';
  
  try {
    // For multiple files, convert them one by one to show real progress
    if (files.length > 1) {
      const convertedFiles = [];
      
      for (let i = 0; i < files.length; i++) {
        // Update progress message
        progressMessage.textContent = `Converting image ${i + 1} of ${files.length}...`;
        
        // Create FormData for single file
        const singleFormData = new FormData();
        singleFormData.append('files[]', files[i]);
        singleFormData.append('output_format', document.getElementById('outputFormat').value);
        singleFormData.append('quality', document.getElementById('quality').value);
        
        const width = document.getElementById('width').value;
        const height = document.getElementById('height').value;
        if (width) singleFormData.append('width', width);
        if (height) singleFormData.append('height', height);
        
        // Convert single file
        const response = await fetch('/api/v1/tools/image-format-converter/convert/', {
          method: 'POST',
          body: singleFormData,
        });
        
        if (!response.ok) {
          console.error(`Failed to convert ${files[i].name}`);
          // Continue with next file
          continue;
        }
        
        const blob = await response.blob();
        const outputFormat = document.getElementById('outputFormat').value;
        const originalName = files[i].name;
        const baseName = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
        const newFileName = `${baseName}.${outputFormat}`;
        
        convertedFiles.push({
          name: newFileName,
          blob: blob
        });
        
        // Update progress bar
        const progress = Math.round(((i + 1) / files.length) * 100);
        progressBar.style.width = progress + '%';
        progressText.textContent = progress + '%';
      }
      
      // Create ZIP file from converted files
      progressMessage.textContent = 'Creating ZIP archive...';
      
      // Use JSZip library if available, otherwise create simple blob
      if (convertedFiles.length > 0) {
        // For now, we'll send all files again to get the ZIP
        // In a real implementation, you might want to use JSZip on client side
        const response = await fetch('/api/v1/tools/image-format-converter/convert/', {
          method: 'POST',
          body: formData,
        });
        
        if (!response.ok) {
          throw new Error('Failed to create ZIP archive');
        }
        
        const contentType = response.headers.get('content-type');
        const blob = await response.blob();
        const outputFormat = document.getElementById('outputFormat').value;
        
        // Complete progress
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        
        // Show ZIP download
        const zipUrl = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const zipFilename = `converted_images_${timestamp}.zip`;
        
        resultSection.innerHTML = `
          <div class="alert alert-success">
            <h5 class="alert-heading">
              <i class="bi bi-check-circle me-2"></i>Conversion Complete!
            </h5>
            <p class="mb-0">Successfully converted ${files.length} images to ${outputFormat.toUpperCase()} format.</p>
          </div>
          
          <div class="card mb-3">
            <div class="card-body text-center py-5">
              <i class="bi bi-file-zip text-primary" style="font-size: 4rem;"></i>
              <h5 class="mt-3">Your images are ready!</h5>
              <p class="text-muted">
                All ${files.length} images have been converted and packaged into a ZIP file.
              </p>
              <div class="d-grid gap-2 col-md-6 mx-auto">
                <a href="${zipUrl}" download="${zipFilename}" class="btn btn-success btn-lg">
                  <i class="bi bi-download me-2"></i>
                  Download ZIP (${MagicToolbox.formatFileSize(blob.size)})
                </a>
                <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                  <i class="bi bi-arrow-clockwise me-2"></i>Convert More Images
                </button>
              </div>
              <div class="mt-3">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  The ZIP file contains all ${files.length} converted images
                </small>
              </div>
            </div>
          </div>
        `;
      }
    } else {
      // Single file conversion - show animated progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 15;
        progressBar.style.width = Math.min(progress, 90) + '%';
        progressText.textContent = Math.min(progress, 90) + '%';
        
        if (progress >= 90) {
          clearInterval(progressInterval);
        }
      }, 150);
      
      // Call the API for actual conversion
      const response = await fetch('/api/v1/tools/image-format-converter/convert/', {
        method: 'POST',
        body: formData,
      });
      
      clearInterval(progressInterval);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Conversion failed');
      }
      
      // Complete progress
      progressBar.style.width = '100%';
      progressText.textContent = '100%';
      
      // Get blob and show result
      const blob = await response.blob();
      const outputFormat = document.getElementById('outputFormat').value;
      const file = files[0];
      const convertedImageUrl = URL.createObjectURL(blob);
      const originalImageUrl = URL.createObjectURL(file);
      
      // Show original image preview
      const originalImage = document.getElementById('originalImage');
      originalImage.src = originalImageUrl;
      document.getElementById('originalInfo').textContent = `${file.name} (${MagicToolbox.formatFileSize(file.size)})`;
      
      // Show converted image
      const convertedImage = document.getElementById('convertedImage');
      convertedImage.src = convertedImageUrl;
      
      const convertedFilename = file.name.replace(/\.[^/.]+$/, '') + '.' + outputFormat;
      document.getElementById('convertedInfo').textContent = `${convertedFilename} (${MagicToolbox.formatFileSize(blob.size)})`;
      
      // Set up download
      const downloadBtn = document.getElementById('downloadBtn');
      downloadBtn.href = convertedImageUrl;
      downloadBtn.download = convertedFilename;
    }
    
    // Show results
    setTimeout(() => {
      progressSection.style.display = 'none';
      resultSection.style.display = 'block';
      convertBtn.disabled = false;
      
      // Scroll to results
      resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 500);
    
  } catch (error) {
    MagicToolbox.showNotification('Conversion failed: ' + error.message, 'error');
    progressSection.style.display = 'none';
    convertBtn.disabled = false;
  }
});
</script>
{% endblock %}
