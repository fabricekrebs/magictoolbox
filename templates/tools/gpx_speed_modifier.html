{% extends 'base.html' %}
{% load static %}

{% block title %}{{ tool.display_name }} - MagicToolbox{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- ==================== BREADCRUMB & HEADER ==================== -->
  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tools:tool_list' %}">Tools</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ tool.display_name }}</li>
        </ol>
      </nav>
      
      <h1 class="display-4 mb-3">
        <i class="bi bi-{{ tool.icon }} text-primary me-3"></i>
        {{ tool.display_name }}
      </h1>
      <p class="lead text-muted">{{ tool.description }}</p>
    </div>
  </div>

  <div class="row">
    <!-- ==================== MAIN CONTENT (LEFT COLUMN) ==================== -->
    <div class="col-lg-8">
      <!-- Upload Card -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-upload me-2"></i>Upload GPX File
          </h5>
        </div>
        <div class="card-body">
          <form id="toolForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- File Input -->
            <div class="mb-3">
              <label for="inputFile" class="form-label">
                Select GPX File(s)
                <span class="badge bg-success">Bulk supported!</span>
              </label>
              <input 
                type="file" 
                class="form-control" 
                id="inputFile" 
                name="files[]" 
                accept=".gpx"
                multiple 
                required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Select one or multiple GPX files (max 50MB per file).
              </div>
              <div id="fileList" class="mt-2"></div>
            </div>

            <!-- Mode Selection -->
            <div class="mb-3">
              <label class="form-label">Action</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="mode" id="modeAnalyze" value="analyze" checked>
                <label class="btn btn-outline-primary" for="modeAnalyze">
                  <i class="bi bi-bar-chart me-2"></i>Analyze Only
                </label>
                
                <input type="radio" class="btn-check" name="mode" id="modeModify" value="modify">
                <label class="btn btn-outline-primary" for="modeModify">
                  <i class="bi bi-speedometer2 me-2"></i>Modify Speed
                </label>
              </div>
              <div class="form-text">
                Analyze: Get statistics without modifying the file<br>
                Modify: Change speed and download modified GPX
              </div>
            </div>

            <!-- Speed Modifier (shown only in modify mode) -->
            <div id="speedModifierSection" class="mb-3" style="display: none;">
              <label for="speedMultiplier" class="form-label">
                Speed Multiplier: <span id="speedValue">1.0</span>x
                <small class="text-muted">(Average speed will be multiplied by this factor)</small>
              </label>
              <input 
                type="range" 
                class="form-range" 
                id="speedMultiplier" 
                name="speed_multiplier" 
                min="0.1" 
                max="10.0" 
                step="0.1" 
                value="1.0">
              <div class="d-flex justify-content-between small text-muted">
                <span>0.1x (10% speed)</span>
                <span>1.0x (original)</span>
                <span>10.0x (10x speed)</span>
              </div>
            </div>
            
            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="convertBtn">
                <i class="bi bi-play-circle me-2"></i><span id="btnText">Analyze Track</span>
              </button>
            </div>
          </form>

          <!-- ==================== PROGRESS SECTION ==================== -->
          <div id="progressSection" class="mt-4" style="display: none;">
            <div class="progress" style="height: 30px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                   role="progressbar" 
                   id="progressBar"
                   style="width: 0%">
                <span id="progressText">0%</span>
              </div>
            </div>
            <p class="text-center text-muted mt-2" id="progressMessage">Processing your file...</p>
          </div>

          <!-- ==================== ANALYSIS RESULT ==================== -->
          <div id="analysisSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Analysis Complete!
              </h5>
            </div>

            <div class="card">
              <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Track Statistics</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-map me-2"></i>Distance</h6>
                    <p class="h4 mb-0" id="statDistance">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-clock me-2"></i>Duration</h6>
                    <p class="h4 mb-0" id="statDuration">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-speedometer me-2"></i>Average Speed</h6>
                    <p class="h4 mb-0" id="statAvgSpeed">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-lightning me-2"></i>Max Speed</h6>
                    <p class="h4 mb-0" id="statMaxSpeed">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-arrow-up-circle me-2"></i>Elevation Gain</h6>
                    <p class="h4 mb-0" id="statElevGain">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-arrow-down-circle me-2"></i>Elevation Loss</h6>
                    <p class="h4 mb-0" id="statElevLoss">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-geo-alt me-2"></i>Elevation Range</h6>
                    <p class="h4 mb-0" id="statElevRange">-</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <h6 class="text-primary"><i class="bi bi-pin me-2"></i>Track Points</h6>
                    <p class="h4 mb-0" id="statPoints">-</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 mt-3">
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Analyze Another File
              </button>
            </div>
          </div>

          <!-- ==================== SINGLE FILE RESULT (MODIFY MODE) ==================== -->
          <div id="resultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Speed Modification Successful!
              </h5>
              <p class="mb-0">Your GPX file has been modified with the new speed.</p>
            </div>

            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">File Details</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">Original File</h6>
                    <p class="mb-1" id="originalFileName"></p>
                    <small class="text-muted" id="originalFileInfo"></small>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-muted mb-2">Modified File</h6>
                    <p class="mb-1" id="convertedFileName"></p>
                    <small class="text-muted" id="convertedFileInfo"></small>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2">
              <a href="#" id="downloadBtn" class="btn btn-success btn-lg" download>
                <i class="bi bi-download me-2"></i>Download Modified GPX
              </a>
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Modify Another File
              </button>
            </div>
          </div>

          <!-- ==================== BULK RESULT SECTION ==================== -->
          <div id="bulkResultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Batch Processing Complete!
              </h5>
              <p class="mb-0">Successfully processed <span id="successCount">0</span> file(s).</p>
            </div>

            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">Processing Results</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Original File</th>
                        <th>Status</th>
                        <th>Result File</th>
                        <th>Size</th>
                      </tr>
                    </thead>
                    <tbody id="bulkResultsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2">
              <a href="#" id="downloadZipBtn" class="btn btn-success btn-lg" download>
                <i class="bi bi-file-earmark-zip me-2"></i>Download All as ZIP
              </a>
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Process More Files
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== SIDEBAR (RIGHT COLUMN) ==================== -->
    <div class="col-lg-4">
      <!-- Features Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-star me-2"></i>Features
          </h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li><i class="bi bi-check-circle text-success me-2"></i>Detailed track analysis</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Distance and duration</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Speed statistics</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Elevation data</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Modify average speed</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Preserves distance & elevation</li>
            <li><i class="bi bi-check-circle text-success me-2"></i>Bulk processing support</li>
          </ul>
        </div>
      </div>

      <!-- How It Works Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>How It Works
          </h6>
        </div>
        <div class="card-body">
          <p class="small mb-2"><strong>Analyze Mode:</strong></p>
          <p class="small text-muted mb-3">Extracts all statistics from your GPX file without making any changes.</p>
          
          <p class="small mb-2"><strong>Modify Mode:</strong></p>
          <p class="small text-muted mb-0">Adjusts the timestamps in your GPX file to achieve the desired average speed. The route, distance, and elevation data remain unchanged - only the time between points is recalculated.</p>
        </div>
      </div>

      <!-- Use Cases Card -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-lightbulb me-2"></i>Use Cases
          </h6>
        </div>
        <div class="card-body">
          <ul class="small mb-0">
            <li>Analyze recorded tracks</li>
            <li>Create training plans with different paces</li>
            <li>Adjust virtual ride speeds</li>
            <li>Compare different speed scenarios</li>
            <li>Generate realistic activity times</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ==================== MODE SWITCHING ====================
const modeRadios = document.querySelectorAll('input[name="mode"]');
const speedModifierSection = document.getElementById('speedModifierSection');
const btnText = document.getElementById('btnText');

modeRadios.forEach(radio => {
  radio.addEventListener('change', function() {
    if (this.value === 'modify') {
      speedModifierSection.style.display = 'block';
      btnText.textContent = 'Modify Track Speed';
    } else {
      speedModifierSection.style.display = 'none';
      btnText.textContent = 'Analyze Track';
    }
  });
});

// ==================== SPEED MULTIPLIER SLIDER ====================
const speedSlider = document.getElementById('speedMultiplier');
const speedValue = document.getElementById('speedValue');

speedSlider.addEventListener('input', function() {
  speedValue.textContent = parseFloat(this.value).toFixed(1);
});

// ==================== FILE LIST DISPLAY ====================
const fileInput = document.getElementById('inputFile');
const fileListDiv = document.getElementById('fileList');

fileInput.addEventListener('change', function() {
  const files = Array.from(fileInput.files);
  if (files.length === 0) {
    fileListDiv.innerHTML = '';
    return;
  }

  let html = '<div class="list-group">';
  let totalSize = 0;
  
  files.forEach((file, index) => {
    totalSize += file.size;
    
    html += `
      <div class="list-group-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-file-earmark-arrow-down me-2 text-primary"></i>
            <strong>${file.name}</strong>
          </div>
          <small class="text-muted">${MagicToolbox.formatFileSize(file.size)}</small>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  if (files.length > 1) {
    html += `
      <div class="alert alert-info mt-2 mb-0">
        <i class="bi bi-info-circle me-1"></i>
        <strong>${files.length} files selected</strong> (Total: ${MagicToolbox.formatFileSize(totalSize)})
      </div>
    `;
  }
  
  fileListDiv.innerHTML = html;
});

// ==================== FORM SUBMISSION ====================
document.getElementById('toolForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const files = Array.from(fileInput.files);
  if (files.length === 0) {
    MagicToolbox.showNotification('Please select at least one file', 'error');
    return;
  }

  const mode = document.querySelector('input[name="mode"]:checked').value;
  const convertBtn = document.getElementById('convertBtn');
  const progressSection = document.getElementById('progressSection');
  const analysisSection = document.getElementById('analysisSection');
  const resultSection = document.getElementById('resultSection');
  const bulkResultSection = document.getElementById('bulkResultSection');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  const progressMessage = document.getElementById('progressMessage');
  
  // Show progress
  convertBtn.disabled = true;
  progressSection.style.display = 'block';
  analysisSection.style.display = 'none';
  resultSection.style.display = 'none';
  bulkResultSection.style.display = 'none';
  
  // Determine mode
  const isBulk = files.length > 1;
  progressMessage.textContent = isBulk 
    ? `Processing ${files.length} files...` 
    : 'Processing your file...';
  
  try {
    if (isBulk) {
      await handleBulkProcessing(files, mode, progressBar, progressText);
    } else {
      if (mode === 'analyze') {
        await handleSingleAnalysis(files[0], progressBar, progressText, this);
      } else {
        await handleSingleModification(files[0], progressBar, progressText, this);
      }
    }
  } catch (error) {
    console.error('Processing error:', error);
    MagicToolbox.showNotification(error.message || 'Processing failed', 'error');
    progressSection.style.display = 'none';
  } finally {
    convertBtn.disabled = false;
  }
});

// ==================== SINGLE FILE ANALYSIS ====================
async function handleSingleAnalysis(file, progressBar, progressText, form) {
  const progressSection = document.getElementById('progressSection');
  const analysisSection = document.getElementById('analysisSection');
  
  // Animate progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 15;
    progressBar.style.width = Math.min(progress, 90) + '%';
    progressText.textContent = Math.min(progress, 90) + '%';
    if (progress >= 90) clearInterval(progressInterval);
  }, 150);
  
  // Prepare form data
  const formData = new FormData();
  formData.append('file', file);
  formData.append('mode', 'analyze');
  
  try {
    const response = await fetch('/api/v1/tools/gpx-speed-modifier/convert/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    });
    
    clearInterval(progressInterval);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    // Complete progress
    progressBar.style.width = '100%';
    progressText.textContent = '100%';
    
    // Get JSON analysis result
    const stats = await response.json();
    
    // Display statistics
    document.getElementById('statDistance').textContent = `${stats.total_distance_km} km`;
    document.getElementById('statDuration').textContent = stats.total_duration_formatted;
    document.getElementById('statAvgSpeed').textContent = `${stats.average_speed_kmh} km/h`;
    document.getElementById('statMaxSpeed').textContent = `${stats.max_speed_kmh} km/h`;
    document.getElementById('statElevGain').textContent = `${stats.elevation_gain_m} m`;
    document.getElementById('statElevLoss').textContent = `${stats.elevation_loss_m} m`;
    document.getElementById('statElevRange').textContent = 
      `${stats.min_elevation_m} - ${stats.max_elevation_m} m`;
    document.getElementById('statPoints').textContent = stats.total_points;
    
    // Show results
    setTimeout(() => {
      progressSection.style.display = 'none';
      analysisSection.style.display = 'block';
      MagicToolbox.showNotification('Analysis complete!', 'success');
    }, 500);
  } catch (error) {
    throw error;
  }
}

// ==================== SINGLE FILE MODIFICATION ====================
async function handleSingleModification(file, progressBar, progressText, form) {
  const progressSection = document.getElementById('progressSection');
  const resultSection = document.getElementById('resultSection');
  const speedMultiplier = document.getElementById('speedMultiplier').value;
  
  // Animate progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 15;
    progressBar.style.width = Math.min(progress, 90) + '%';
    progressText.textContent = Math.min(progress, 90) + '%';
    if (progress >= 90) clearInterval(progressInterval);
  }, 150);
  
  // Prepare form data
  const formData = new FormData();
  formData.append('file', file);
  formData.append('mode', 'modify');
  formData.append('speed_multiplier', speedMultiplier);
  
  try {
    const response = await fetch('/api/v1/tools/gpx-speed-modifier/convert/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    });
    
    clearInterval(progressInterval);
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `Server error: ${response.status}`);
    }
    
    // Complete progress
    progressBar.style.width = '100%';
    progressText.textContent = '100%';
    
    // Get modified file
    const blob = await response.blob();
    const convertedFileUrl = URL.createObjectURL(blob);
    
    // Extract filename from Content-Disposition
    const contentDisposition = response.headers.get('Content-Disposition');
    let convertedFilename = file.name;
    if (contentDisposition) {
      const matches = /filename="([^"]+)"/.exec(contentDisposition);
      if (matches) convertedFilename = matches[1];
    }
    
    // Update UI
    document.getElementById('originalFileName').textContent = file.name;
    document.getElementById('originalFileInfo').textContent = 
      `GPX | ${MagicToolbox.formatFileSize(file.size)}`;
    
    document.getElementById('convertedFileName').textContent = convertedFilename;
    document.getElementById('convertedFileInfo').textContent = 
      `GPX | ${MagicToolbox.formatFileSize(blob.size)} | Speed: ${speedMultiplier}x`;
    
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.href = convertedFileUrl;
    downloadBtn.download = convertedFilename;
    
    // Show results
    setTimeout(() => {
      progressSection.style.display = 'none';
      resultSection.style.display = 'block';
      MagicToolbox.showNotification('Speed modification successful!', 'success');
    }, 500);
  } catch (error) {
    throw error;
  }
}

// ==================== BULK PROCESSING ====================
async function handleBulkProcessing(files, mode, progressBar, progressText) {
  const progressSection = document.getElementById('progressSection');
  const bulkResultSection = document.getElementById('bulkResultSection');
  const speedMultiplier = mode === 'modify' ? document.getElementById('speedMultiplier').value : null;
  
  const results = [];
  const convertedBlobs = [];
  let successCount = 0;
  
  // Process each file sequentially
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const percent = Math.round(((i + 1) / files.length) * 100);
    
    progressBar.style.width = percent + '%';
    progressText.textContent = `${percent}% (${i + 1}/${files.length})`;
    
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('mode', mode);
      if (mode === 'modify') {
        formData.append('speed_multiplier', speedMultiplier);
      }
      
      const response = await fetch('/api/v1/tools/gpx-speed-modifier/convert/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });
      
      if (response.ok) {
        const blob = await response.blob();
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = file.name;
        if (contentDisposition) {
          const matches = /filename="([^"]+)"/.exec(contentDisposition);
          if (matches) filename = matches[1];
        }
        
        convertedBlobs.push({ blob, filename });
        results.push({
          originalName: file.name,
          convertedName: filename,
          size: blob.size,
          status: 'success'
        });
        successCount++;
      } else {
        results.push({
          originalName: file.name,
          status: 'error',
          error: 'Processing failed'
        });
      }
    } catch (error) {
      results.push({
        originalName: file.name,
        status: 'error',
        error: error.message
      });
    }
  }
  
  // Display results table
  const tableBody = document.getElementById('bulkResultsTable');
  if (!tableBody) {
    throw new Error('Results table not found');
  }
  
  tableBody.innerHTML = '';
  results.forEach(result => {
    const row = document.createElement('tr');
    if (result.status === 'success') {
      row.innerHTML = `
        <td>${result.originalName}</td>
        <td><span class="badge bg-success">Success</span></td>
        <td>${result.convertedName}</td>
        <td>${MagicToolbox.formatFileSize(result.size)}</td>
      `;
    } else {
      row.innerHTML = `
        <td>${result.originalName}</td>
        <td><span class="badge bg-danger">Failed</span></td>
        <td colspan="2"><small class="text-danger">${result.error}</small></td>
      `;
    }
    tableBody.appendChild(row);
  });
  
  document.getElementById('successCount').textContent = successCount;
  
  // Create ZIP file
  if (successCount > 0) {
    const JSZip = window.JSZip;
    if (JSZip) {
      const zip = new JSZip();
      convertedBlobs.forEach(({ blob, filename }) => {
        zip.file(filename, blob);
      });
      
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const zipUrl = URL.createObjectURL(zipBlob);
      
      const downloadZipBtn = document.getElementById('downloadZipBtn');
      if (downloadZipBtn) {
        downloadZipBtn.href = zipUrl;
        downloadZipBtn.download = `gpx_processed_${mode}.zip`;
      }
    }
  }
  
  // Show results
  setTimeout(() => {
    progressSection.style.display = 'none';
    bulkResultSection.style.display = 'block';
    MagicToolbox.showNotification(
      `Processed ${successCount} of ${files.length} files`, 
      successCount > 0 ? 'success' : 'error'
    );
  }, 500);
}
</script>
{% endblock %}
