{% extends "base.html" %}
{% load static %}

{% block title %}GPX/KML Converter - MagicToolbox{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tool-history.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <!-- Tool Header -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tools:tool_list' %}">Tools</a></li>
          <li class="breadcrumb-item active" aria-current="page">GPX/KML Converter</li>
        </ol>
      </nav>
      <div>
        <h1 class="display-5 fw-bold mb-2">
          <i class="bi bi-geo-alt text-primary me-2"></i>
          GPX/KML Converter
        </h1>
        <p class="lead text-muted mb-0">Convert GPS files between GPX and KML formats. Preserves waypoints, tracks, and routes.</p>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Upload & Status (8 columns) -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-arrow-left-right me-2"></i>Convert GPS File
          </h5>
        </div>
        <div class="card-body">
          <form id="gpxKmlConverterForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-3">
              <label for="gpsFile" class="form-label">Select GPS File</label>
              <input type="file" class="form-control" id="gpsFile" name="file" 
                     accept=".gpx,.kml" required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Supported formats: GPX, KML (max 10MB)
              </div>
            </div>
            
            <div class="mb-3">
              <label for="conversionType" class="form-label">Conversion Direction</label>
              <select class="form-select" id="conversionType" name="conversion_type">
                <option value="">Auto-detect from file extension</option>
                <option value="gpx_to_kml">GPX → KML (Convert to Google Earth format)</option>
                <option value="kml_to_gpx">KML → GPX (Convert to GPS exchange format)</option>
              </select>
              <div class="form-text">
                <i class="bi bi-magic me-1"></i>
                Leave on auto-detect to let us choose based on your file
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="convertBtn">
                <i class="bi bi-arrow-left-right me-2"></i>Convert File
              </button>
            </div>
          </form>

          <!-- Conversion Status Section -->
          <div id="statusSection" class="mt-4" style="display: none;">
            <h5 class="mb-3">
              <i class="bi bi-hourglass-split me-2"></i>Conversion Status
            </h5>
            <div id="conversionStatusList">
              <div class="alert alert-info">
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-3" role="status">
                    <span class="visually-hidden">Processing...</span>
                  </div>
                  <div>
                    <strong id="statusMessage">Uploading file...</strong>
                    <br><small class="text-muted" id="statusDetail">Please wait while we process your GPS file</small>
                  </div>
                </div>
              </div>
              <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                     role="progressbar" 
                     id="progressBar"
                     style="width: 0%">
                  <span id="progressText">0%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div id="resultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>Conversion Completed!
              </h5>
              <p class="mb-0" id="completionSummary">Your GPS file has been converted successfully.</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-grid gap-2 mt-3">
              <a href="#" id="downloadBtn" class="btn btn-success btn-lg" download>
                <i class="bi bi-download me-2"></i>Download Converted File
              </a>
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Convert Another File
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: History Sidebar (4 columns) -->
    <div class="col-lg-4">
      <div class="history-sidebar">
        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-clock-history me-2"></i>Conversion History
            </h6>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshHistoryBtn" title="Refresh history">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          
          <!-- Search Filter -->
          <div class="history-search">
            <div class="input-group input-group-sm">
              <span class="input-group-text">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" 
                     class="form-control" 
                     id="historySearchInput" 
                     placeholder="Search by filename..."
                     aria-label="Search history">
            </div>
          </div>
          
          <div class="card-body p-0">
            <!-- Loading state -->
            <div id="historyLoading" class="text-center py-4" style="display: none;">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-muted small mt-2 mb-0">Loading history...</p>
            </div>
            
            <!-- Empty state -->
            <div id="historyEmpty" class="text-center py-4" style="display: none;">
              <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted small mt-2 mb-0">No conversion history yet</p>
            </div>
            
            <!-- History list -->
            <div id="historyList" class="list-group list-group-flush"></div>
          </div>
        </div>
        
        <!-- Tool Information -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="bi bi-info-circle me-2"></i>Format Information
            </h6>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <span class="badge bg-primary me-2">GPX</span>
              <small class="text-muted">GPS Exchange Format - Universal GPS data format</small>
            </div>
            <div>
              <span class="badge bg-success me-2">KML</span>
              <small class="text-muted">Keyhole Markup Language - Google Earth format</small>
            </div>
          </div>
        </div>

        <div class="card shadow-sm mt-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="bi bi-lightbulb me-2"></i>Usage Tips
            </h6>
          </div>
          <div class="card-body">
            <ul class="small mb-0">
              <li>GPX is best for fitness devices and GPS receivers</li>
              <li>KML works best with Google Earth and Maps</li>
              <li>Both formats preserve waypoints, tracks, and routes</li>
              <li>Auto-detect will choose the correct conversion direction</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this conversion from history?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const TOOL_NAME = 'gpx-kml-converter';
let currentExecutionId = null;
let statusPollInterval = null;
let deleteExecutionId = null;

// Format file size helper
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Format time ago helper
function formatTimeAgo(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const seconds = Math.floor((now - date) / 1000);
  
  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
  return Math.floor(seconds / 86400) + 'd ago';
}

// Load history
async function loadHistory() {
  const historyLoading = document.getElementById('historyLoading');
  const historyEmpty = document.getElementById('historyEmpty');
  const historyList = document.getElementById('historyList');
  
  historyLoading.style.display = 'block';
  historyEmpty.style.display = 'none';
  historyList.innerHTML = '';
  
  try {
    const response = await fetch(`/api/v1/executions/?tool_name=${TOOL_NAME}&limit=10`);
    const data = await response.json();
    
    historyLoading.style.display = 'none';
    
    if (!data.results || data.results.length === 0) {
      historyEmpty.style.display = 'block';
      return;
    }
    
    data.results.forEach(item => {
      const statusClass = {
        'completed': 'bg-success',
        'processing': 'bg-primary',
        'pending': 'bg-warning',
        'failed': 'bg-danger'
      }[item.status] || 'bg-secondary';
      
      const historyItem = document.createElement('div');
      historyItem.className = 'list-group-item list-group-item-action';
      historyItem.innerHTML = `
        <div class="d-flex w-100 justify-content-between align-items-start">
          <div class="flex-grow-1 me-2" style="min-width: 0;">
            <div class="d-flex align-items-center mb-1">
              <span class="badge ${statusClass} me-2">${item.status}</span>
              <small class="text-muted">${formatTimeAgo(item.created_at)}</small>
            </div>
            <p class="mb-1 text-truncate small" title="${item.input_filename}">
              <i class="bi bi-file-earmark me-1"></i>${item.input_filename}
            </p>
            ${item.output_filename ? `
              <p class="mb-0 text-truncate small text-success" title="${item.output_filename}">
                <i class="bi bi-arrow-right me-1"></i>${item.output_filename}
              </p>
            ` : ''}
          </div>
          <div class="btn-group btn-group-sm">
            ${item.status === 'completed' ? `
              <a href="/api/v1/executions/${item.id}/download/" class="btn btn-outline-success" title="Download">
                <i class="bi bi-download"></i>
              </a>
            ` : ''}
            <button type="button" class="btn btn-outline-danger" onclick="showDeleteModal('${item.id}')" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
      historyList.appendChild(historyItem);
    });
  } catch (error) {
    console.error('Failed to load history:', error);
    historyLoading.style.display = 'none';
    historyEmpty.style.display = 'block';
  }
}

// Show delete modal
function showDeleteModal(executionId) {
  deleteExecutionId = executionId;
  const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
  modal.show();
}

// Confirm delete
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
  if (!deleteExecutionId) return;
  
  try {
    const response = await fetch(`/api/v1/executions/${deleteExecutionId}/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    if (response.ok) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
      modal.hide();
      loadHistory();
    }
  } catch (error) {
    console.error('Failed to delete:', error);
  }
});

// Check status
async function checkStatus() {
  if (!currentExecutionId) return;
  
  try {
    const response = await fetch(`/api/v1/executions/${currentExecutionId}/status/`);
    const data = await response.json();
    
    const statusMessage = document.getElementById('statusMessage');
    const statusDetail = document.getElementById('statusDetail');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    if (data.status === 'processing') {
      if (statusMessage) statusMessage.textContent = 'Converting GPS file...';
      if (statusDetail) statusDetail.textContent = 'Azure Functions is processing your file';
      if (progressBar) progressBar.style.width = '60%';
      if (progressText) progressText.textContent = '60%';
    } else if (data.status === 'completed') {
      clearInterval(statusPollInterval);
      statusPollInterval = null;
      
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
      }
      if (progressText) progressText.textContent = '100%';
      
      // Show results
      setTimeout(() => {
        const statusSection = document.getElementById('statusSection');
        const resultSection = document.getElementById('resultSection');
        if (statusSection) statusSection.style.display = 'none';
        if (resultSection) resultSection.style.display = 'block';
        
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) downloadBtn.href = `/api/v1/executions/${currentExecutionId}/download/`;
        
        loadHistory();
      }, 500);
      
    } else if (data.status === 'failed') {
      clearInterval(statusPollInterval);
      statusPollInterval = null;
      
      if (statusMessage) statusMessage.textContent = 'Conversion failed';
      if (statusDetail) statusDetail.textContent = data.error_message || 'An error occurred during conversion';
      if (progressBar) {
        progressBar.classList.remove('bg-primary', 'progress-bar-animated');
        progressBar.classList.add('bg-danger');
      }
      
      const convertBtn = document.getElementById('convertBtn');
      if (convertBtn) convertBtn.disabled = false;
      loadHistory();
    }
  } catch (error) {
    console.error('Status check failed:', error);
  }
}

// Handle form submission
document.getElementById('gpxKmlConverterForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const fileInput = document.getElementById('gpsFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert('Please select a GPS file');
    return;
  }

  const formData = new FormData();
  formData.append('file', file);
  
  const conversionType = document.getElementById('conversionType').value;
  if (conversionType) {
    formData.append('conversion_type', conversionType);
  }
  
  const convertBtn = document.getElementById('convertBtn');
  const statusSection = document.getElementById('statusSection');
  const resultSection = document.getElementById('resultSection');
  const progressBar = document.getElementById('progressBar');
  
  // Show status section
  convertBtn.disabled = true;
  statusSection.style.display = 'block';
  resultSection.style.display = 'none';
  
  // Reset progress
  progressBar.style.width = '10%';
  progressBar.classList.remove('bg-success', 'bg-danger');
  progressBar.classList.add('bg-primary', 'progress-bar-animated', 'progress-bar-striped');
  
  const progressText = document.getElementById('progressText');
  const statusMessage = document.getElementById('statusMessage');
  const statusDetail = document.getElementById('statusDetail');
  
  if (progressText) progressText.textContent = '10%';
  if (statusMessage) statusMessage.textContent = 'Uploading file...';
  if (statusDetail) statusDetail.textContent = 'Please wait...';
  
  try {
    const response = await fetch(`/api/v1/tools/${TOOL_NAME}/convert/`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Upload failed');
    }
    
    const data = await response.json();
    currentExecutionId = data.executionId;
    
    // Update progress
    progressBar.style.width = '30%';
    const progressText2 = document.getElementById('progressText');
    const statusMessage2 = document.getElementById('statusMessage');
    const statusDetail2 = document.getElementById('statusDetail');
    
    if (progressText2) progressText2.textContent = '30%';
    if (statusMessage2) statusMessage2.textContent = 'Processing...';
    if (statusDetail2) statusDetail2.textContent = 'File uploaded, waiting for conversion';
    
    // Start polling for status
    statusPollInterval = setInterval(checkStatus, 2000);
    
  } catch (error) {
    alert('Error: ' + error.message);
    convertBtn.disabled = false;
    statusSection.style.display = 'none';
  }
});

// Refresh history button
document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);

// History search
document.getElementById('historySearchInput').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const items = document.querySelectorAll('#historyList .list-group-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? '' : 'none';
  });
});

// Load history on page load
document.addEventListener('DOMContentLoaded', loadHistory);
</script>
{% endblock %}
