{% extends 'base.html' %}
{% load static crispy_forms_tags %}

{% block title %}{{ tool.display_name }} - MagicToolbox{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tool-history.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
  <!-- Tool Header -->
  <div class="row mb-4">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'tools:tool_list' %}">Tools</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ tool.display_name }}</li>
        </ol>
      </nav>
      <div>
        <h1 class="display-5 fw-bold mb-2">
          <i class="bi bi-file-earmark-word text-primary me-2"></i>
          {{ tool.display_name }}
        </h1>
        <p class="lead text-muted mb-0">{{ tool.description }}</p>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Upload & Status (8 columns) -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-upload me-2"></i>Upload & Convert PDF
          </h5>
        </div>
        <div class="card-body">
          <form id="pdfConverterForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="pdfFiles" class="form-label">
                Select PDF Documents
              </label>
              <input type="file" class="form-control" id="pdfFiles" name="files" accept=".pdf,application/pdf" multiple required>
              <div class="form-text">
                <i class="bi bi-info-circle me-1"></i>
                Select one or more PDF documents (max 100MB each)
              </div>
            </div>

            <!-- File List -->
            <div id="fileListSection" class="mb-3" style="display: none;">
              <label class="form-label">Selected Files:</label>
              <div id="fileList" class="list-group"></div>
            </div>

            <div class="card bg-light mb-3">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="bi bi-file-earmark-text me-2"></i>Page Selection <span class="text-muted small">(Optional)</span>
                </h6>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label for="startPage" class="form-label">Start Page</label>
                    <input type="number" class="form-control" id="startPage" name="start_page" min="0" placeholder="0 (first page)">
                    <small class="form-text text-muted">Page numbering starts at 0</small>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label for="endPage" class="form-label">End Page</label>
                    <input type="number" class="form-control" id="endPage" name="end_page" min="0" placeholder="All pages">
                    <small class="form-text text-muted">Leave empty for all pages</small>
                  </div>
                </div>
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Leave both fields empty to convert the entire document
                </small>
              </div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="convertBtn">
                <i class="bi bi-arrow-repeat me-2"></i>Convert to DOCX
              </button>
            </div>
          </form>

          <!-- Conversion Status Section -->
          <div id="statusSection" class="mt-4" style="display: none;">
            <h5 class="mb-3">
              <i class="bi bi-hourglass-split me-2"></i>Conversion Status
            </h5>
            <div id="conversionStatusList"></div>
            
            <!-- Overall Progress -->
            <div class="card mt-3 bg-light">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-bold">Overall Progress</span>
                  <span id="overallProgressText" class="text-muted">0 / 0 completed</span>
                </div>
                <div class="progress" style="height: 25px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                       role="progressbar" 
                       id="overallProgressBar"
                       style="width: 0%">
                    <span id="overallPercentage">0%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div id="resultSection" class="mt-4" style="display: none;">
            <div class="alert alert-success" role="alert">
              <h5 class="alert-heading">
                <i class="bi bi-check-circle me-2"></i>All Conversions Completed!
              </h5>
              <p class="mb-0" id="completionSummary"></p>
            </div>

            <!-- Completed Files List -->
            <div id="completedFilesList"></div>
            
            <!-- Action Buttons -->
            <div class="d-grid gap-2 mt-3">
              <button type="button" class="btn btn-success btn-lg" id="downloadAllBtn">
                <i class="bi bi-download me-2"></i>Download All DOCX Files
              </button>
              <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-2"></i>Convert More PDFs
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: History Sidebar (4 columns) -->
    <div class="col-lg-4">
      <div class="history-sidebar">
        <div class="card shadow-sm">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="bi bi-clock-history me-2"></i>Conversion History
            </h6>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshHistoryBtn" title="Refresh history">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          <div class="card-body p-0">
            <!-- Loading state -->
            <div id="historyLoading" class="text-center py-4" style="display: none;">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="text-muted small mt-2 mb-0">Loading history...</p>
            </div>
            
            <!-- Empty state -->
            <div id="historyEmpty" class="text-center py-4" style="display: none;">
              <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
              <p class="text-muted small mt-2 mb-0">No conversion history yet</p>
            </div>
            
            <!-- History list -->
            <div id="historyList" class="list-group list-group-flush"></div>
          </div>
        </div>
        
        <!-- Tool Information (collapsible) -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="bi bi-info-circle me-2"></i>About This Tool
            </h6>
          </div>
          <div class="card-body">
            <div class="accordion accordion-flush" id="toolInfoAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#preservedInfo">
                    What's Preserved
                  </button>
                </h2>
                <div id="preservedInfo" class="accordion-collapse collapse" data-bs-parent="#toolInfoAccordion">
                  <div class="accordion-body">
                    <ul class="small mb-0">
                      <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Text content and formatting</li>
                      <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Images and graphics</li>
                      <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Tables and layouts</li>
                      <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Basic font styles</li>
                      <li class="mb-2"><i class="bi bi-check-circle text-success me-1"></i> Paragraphs and spacing</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#limitations">
                    Limitations
                  </button>
                </h2>
                <div id="limitations" class="accordion-collapse collapse" data-bs-parent="#toolInfoAccordion">
                  <div class="accordion-body">
                    <ul class="small mb-0">
                      <li class="mb-2">Complex layouts may not convert perfectly</li>
                      <li class="mb-2">Some fonts may be substituted</li>
                      <li class="mb-2">Scanned PDFs require OCR (not supported)</li>
                      <li class="mb-2">Password-protected PDFs not supported</li>
                      <li class="mb-2">Form fields may not be preserved</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#usageTips">
                    Usage Tips
                  </button>
                </h2>
                <div id="usageTips" class="accordion-collapse collapse" data-bs-parent="#toolInfoAccordion">
                  <div class="accordion-body">
                    <ul class="small mb-0">
                      <li class="mb-2">Best results with text-based PDFs</li>
                      <li class="mb-2">Use page selection to convert specific pages</li>
                      <li class="mb-2">Converted DOCX can be edited in Microsoft Word</li>
                      <li class="mb-2">Review formatting after conversion</li>
                      <li class="mb-2">File size may increase after conversion</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global state
let executionData = {};  // { executionId: { filename, status, downloadUrl, ... } }
let statusPollInterval = null;

// Show selected files
const fileInput = document.getElementById('pdfFiles');
const fileListSection = document.getElementById('fileListSection');
const fileList = document.getElementById('fileList');

fileInput.addEventListener('change', function() {
  const files = Array.from(fileInput.files);
  
  if (files.length === 0) {
    fileListSection.style.display = 'none';
    return;
  }

  fileListSection.style.display = 'block';
  fileList.innerHTML = '';
  
  files.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    fileItem.innerHTML = `
      <div>
        <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
        <strong>${file.name}</strong>
      </div>
      <span class="badge bg-secondary">${MagicToolbox.formatFileSize(file.size)}</span>
    `;
    fileList.appendChild(fileItem);
  });
});

// Handle form submission
document.getElementById('pdfConverterForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const files = Array.from(fileInput.files);
  
  if (files.length === 0) {
    MagicToolbox.showNotification('Please select at least one PDF file', 'error');
    return;
  }

  const formData = new FormData();
  
  // Add all files
  files.forEach(file => {
    formData.append('files[]', file);
  });
  
  // Add page selection parameters if provided
  const startPage = document.getElementById('startPage').value;
  const endPage = document.getElementById('endPage').value;
  
  if (startPage) {
    formData.append('start_page', startPage);
  }
  if (endPage) {
    formData.append('end_page', endPage);
  }
  
  const convertBtn = document.getElementById('convertBtn');
  const statusSection = document.getElementById('statusSection');
  const resultSection = document.getElementById('resultSection');
  
  // Disable submit button
  convertBtn.disabled = true;
  
  // Show status section
  statusSection.style.display = 'block';
  resultSection.style.display = 'none';
  
  try {
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    // Call the API to upload files
    const response = await fetch('/api/v1/tools/pdf-docx-converter/convert/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
      },
      body: formData,
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Upload failed');
    }
    
    const data = await response.json();
    
    // Initialize execution tracking
    executionData = {};
    
    if (data.executions) {
      // Multiple files
      data.executions.forEach(exec => {
        executionData[exec.executionId] = {
          filename: exec.filename,
          status: exec.status,
          downloadUrl: null,
        };
      });
    } else if (data.executionId) {
      // Single file
      executionData[data.executionId] = {
        filename: data.filename,
        status: data.status,
        downloadUrl: null,
      };
    }
    
    // Initialize status display
    updateStatusDisplay();
    
    // Start polling for status updates
    startStatusPolling();
    
  } catch (error) {
    MagicToolbox.showNotification('Upload failed: ' + error.message, 'error');
    statusSection.style.display = 'none';
    convertBtn.disabled = false;
  }
});

// Update status display
function updateStatusDisplay() {
  const statusList = document.getElementById('conversionStatusList');
  statusList.innerHTML = '';
  
  const executionIds = Object.keys(executionData);
  
  executionIds.forEach(executionId => {
    const exec = executionData[executionId];
    const statusCard = createStatusCard(executionId, exec);
    statusList.appendChild(statusCard);
  });
  
  // Update overall progress
  updateOverallProgress();
}

// Create status card for a file
function createStatusCard(executionId, exec) {
  const card = document.createElement('div');
  card.className = 'card mb-2';
  card.id = `status-${executionId}`;
  
  let statusBadge = '';
  let progressBar = '';
  let downloadButton = '';
  
  if (exec.status === 'pending') {
    statusBadge = '<span class="badge bg-secondary">Pending</span>';
    progressBar = `
      <div class="progress mt-2" style="height: 20px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             style="width: 25%">Uploading...</div>
      </div>
    `;
  } else if (exec.status === 'processing') {
    statusBadge = '<span class="badge bg-primary">Processing</span>';
    progressBar = `
      <div class="progress mt-2" style="height: 20px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
             style="width: 75%">Converting...</div>
      </div>
    `;
  } else if (exec.status === 'completed') {
    statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>';
    progressBar = `
      <div class="progress mt-2" style="height: 20px;">
        <div class="progress-bar bg-success" style="width: 100%">Done</div>
      </div>
    `;
    if (exec.downloadUrl) {
      const outputFilename = exec.outputFilename || exec.filename.replace(/\.pdf$/i, '.docx');
      downloadButton = `
        <a href="${exec.downloadUrl}" class="btn btn-sm btn-success mt-2" download="${outputFilename}">
          <i class="bi bi-download me-1"></i>Download
        </a>
      `;
    }
  } else if (exec.status === 'failed') {
    statusBadge = '<span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>Failed</span>';
    progressBar = `
      <div class="alert alert-danger mt-2 mb-0">
        ${exec.error || 'Conversion failed'}
      </div>
    `;
  }
  
  card.innerHTML = `
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <h6 class="mb-1">
            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
            ${exec.filename}
          </h6>
          ${statusBadge}
        </div>
      </div>
      ${progressBar}
      ${downloadButton}
    </div>
  `;
  
  return card;
}

// Update overall progress
function updateOverallProgress() {
  const executionIds = Object.keys(executionData);
  const totalFiles = executionIds.length;
  const completedFiles = executionIds.filter(id => 
    executionData[id].status === 'completed'
  ).length;
  const failedFiles = executionIds.filter(id => 
    executionData[id].status === 'failed'
  ).length;
  
  const percentage = totalFiles > 0 ? Math.round((completedFiles / totalFiles) * 100) : 0;
  
  document.getElementById('overallProgressText').textContent = 
    `${completedFiles} / ${totalFiles} completed${failedFiles > 0 ? ` (${failedFiles} failed)` : ''}`;
  document.getElementById('overallProgressBar').style.width = `${percentage}%`;
  document.getElementById('overallPercentage').textContent = `${percentage}%`;
  
  // Check if all completed or failed
  if (completedFiles + failedFiles === totalFiles) {
    stopStatusPolling();
    showResults(completedFiles, failedFiles);
  }
}

// Start polling for status updates
function startStatusPolling() {
  // Poll every 2 seconds
  statusPollInterval = setInterval(checkBatchStatus, 2000);
  
  // Initial check
  checkBatchStatus();
}

// Stop polling
function stopStatusPolling() {
  if (statusPollInterval) {
    clearInterval(statusPollInterval);
    statusPollInterval = null;
  }
}

// Check batch status
async function checkBatchStatus() {
  const executionIds = Object.keys(executionData);
  
  if (executionIds.length === 0) {
    return;
  }
  
  try {
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    
    const response = await fetch('/api/v1/executions/batch-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({ executionIds }),
    });
    
    if (!response.ok) {
      console.error('Failed to check status');
      return;
    }
    
    const data = await response.json();
    
    // Update execution data
    data.executions.forEach(exec => {
      if (executionData[exec.executionId]) {
        executionData[exec.executionId].status = exec.status;
        executionData[exec.executionId].outputFilename = exec.outputFilename;
        executionData[exec.executionId].error = exec.error;
        
        if (exec.downloadUrl) {
          executionData[exec.executionId].downloadUrl = exec.downloadUrl;
        }
      }
    });
    
    // Update display
    updateStatusDisplay();
    
  } catch (error) {
    console.error('Error checking status:', error);
  }
}

// Show results
function showResults(completedFiles, failedFiles) {
  const resultSection = document.getElementById('resultSection');
  const completionSummary = document.getElementById('completionSummary');
  const completedFilesList = document.getElementById('completedFilesList');
  
  // Update summary
  if (failedFiles === 0) {
    completionSummary.textContent = `Successfully converted ${completedFiles} PDF${completedFiles !== 1 ? 's' : ''} to DOCX format.`;
  } else {
    completionSummary.textContent = `Converted ${completedFiles} file${completedFiles !== 1 ? 's' : ''} successfully. ${failedFiles} file${failedFiles !== 1 ? 's' : ''} failed.`;
  }
  
  // Build completed files list
  completedFilesList.innerHTML = '';
  
  Object.keys(executionData).forEach(executionId => {
    const exec = executionData[executionId];
    
    if (exec.status === 'completed' && exec.downloadUrl) {
      const outputFilename = exec.outputFilename || exec.filename.replace(/\.pdf$/i, '.docx');
      
      const fileCard = document.createElement('div');
      fileCard.className = 'card mb-2';
      fileCard.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-file-earmark-word text-primary me-2"></i>
              <strong>${outputFilename}</strong>
            </div>
            <a href="${exec.downloadUrl}" class="btn btn-sm btn-success" download="${outputFilename}">
              <i class="bi bi-download me-1"></i>Download
            </a>
          </div>
        </div>
      `;
      
      completedFilesList.appendChild(fileCard);
    }
  });
  
  // Set up download all button
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  if (completedFiles > 0) {
    downloadAllBtn.style.display = 'block';
    downloadAllBtn.onclick = downloadAllFiles;
  } else {
    downloadAllBtn.style.display = 'none';
  }
  
  // Show results section
  resultSection.style.display = 'block';
  
  // Re-enable convert button
  document.getElementById('convertBtn').disabled = false;
  
  // Scroll to results
  resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Download all completed files
async function downloadAllFiles() {
  const completedExecutions = Object.keys(executionData).filter(id => 
    executionData[id].status === 'completed' && executionData[id].downloadUrl
  );
  
  if (completedExecutions.length === 0) {
    return;
  }
  
  // Download each file with a small delay
  for (let i = 0; i < completedExecutions.length; i++) {
    const exec = executionData[completedExecutions[i]];
    const outputFilename = exec.outputFilename || exec.filename.replace(/\.pdf$/i, '.docx');
    
    // Create temporary link and click it
    const link = document.createElement('a');
    link.href = exec.downloadUrl;
    link.download = outputFilename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Small delay between downloads
    if (i < completedExecutions.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  }
  
  MagicToolbox.showNotification(`Downloaded ${completedExecutions.length} file${completedExecutions.length !== 1 ? 's' : ''}`, 'success');
}

// Initialize history on page load
document.addEventListener('DOMContentLoaded', function() {
  if (typeof ToolHistory !== 'undefined') {
    ToolHistory.loadHistory('pdf-docx-converter', {
      onDeleteSuccess: function() {
        MagicToolbox.showNotification('Item deleted successfully', 'success');
      },
      onDeleteError: function(error) {
        MagicToolbox.showNotification('Failed to delete item: ' + error, 'error');
      }
    });
    
    // Manual refresh button
    document.getElementById('refreshHistoryBtn')?.addEventListener('click', function() {
      ToolHistory.loadHistory('pdf-docx-converter');
    });
  }
});

// Override showResults to refresh history after completion
const originalShowResults = showResults;
showResults = function(completedFiles, failedFiles) {
  originalShowResults(completedFiles, failedFiles);
  
  // Refresh history after successful conversions
  if (completedFiles > 0 && typeof ToolHistory !== 'undefined') {
    setTimeout(() => {
      ToolHistory.loadHistory('pdf-docx-converter');
    }, 1000);
  }
};
</script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteHistoryModal" tabindex="-1" aria-labelledby="deleteHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteHistoryModalLabel">
          <i class="bi bi-trash me-2"></i>Delete Conversion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this conversion?</p>
        <p class="text-muted small mb-0">
          <i class="bi bi-info-circle me-1"></i>
          This will permanently delete both the input and output files.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-1"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/tool-history.js' %}"></script>
{% endblock %}
