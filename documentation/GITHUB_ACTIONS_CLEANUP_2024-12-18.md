# GitHub Actions Workflow Cleanup - December 18, 2024

## Summary

Comprehensive cleanup and standardization of GitHub Actions workflows to fix critical issues, remove redundancy, and improve maintainability.

---

## Changes Made

### üóëÔ∏è Files Deleted (2)

1. **`.github/workflows/develop_func-magictoolbox-dev-rze6cb73hmijy.yml`**
   - **Reason**: Auto-generated by Azure, marked as DISABLED in comments
   - **Issue**: Conflicted with `deploy-function-app.yml`
   - **Problem**: Contained hardcoded resource names and outdated authentication

2. **`.github/workflows/release.yml`**
   - **Reason**: Completely duplicated functionality already in `azure-deploy.yml`
   - **Issue**: Both workflows ran semantic-release on main branch pushes
   - **Problem**: Created circular trigger attempts (release.yml tried to trigger azure-deploy.yml)

---

### üîß Files Modified (3)

#### 1. `.github/workflows/deploy-function-app.yml`

**Change**: Fixed production function deployment packaging

**Before** (Production):
```yaml
- name: Create deployment package
  run: |
    cd function_app
    zip -r ../function_app.zip . -x "*.pyc" -x "__pycache__/*" -x "local.settings.json" -x ".python_packages/*"
```

**After** (Production - matches Development):
```yaml
- name: Create deployment package
  run: |
    echo "üì¶ Creating deployment package with dependencies..."
    cd function_app
    
    # Install dependencies into .python_packages/lib/site-packages
    # This is the standard location for Azure Functions Python
    mkdir -p .python_packages/lib/site-packages
    pip install --target=".python_packages/lib/site-packages" -r requirements.txt
    
    # Create zip with all code and dependencies
    zip -r ../function_app.zip . \
      -x "*.pyc" \
      -x "__pycache__/*" \
      -x ".venv/*" \
      -x "local.settings.json" \
      -x "*.md" \
      -x "function_app_*.py" \
      -x "*.sh"
    echo "‚úÖ Package created: $(du -h ../function_app.zip | cut -f1)"
    echo "üìã Package contents:"
    unzip -l ../function_app.zip | grep -E "(function_app\.py|host\.json|requirements\.txt)" || true
```

**Impact**: 
- ‚úÖ Production now includes dependencies in deployment package
- ‚úÖ Consistent packaging between dev and prod environments
- ‚úÖ Prevents runtime failures due to missing dependencies

---

#### 2. `.github/workflows/azure-deploy.yml`

**Changes**: Multiple standardization improvements

##### Change A: Standardized ACR Secret References

**Before**:
```yaml
- name: Determine ACR based on branch
  id: set_acr
  run: |
    if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
      # Production: use prod ACR secrets
      echo "server=${{ secrets.ACR_LOGIN_SERVER_PROD }}" >> $GITHUB_OUTPUT
      # ... prod secrets ...
    else
      # Development: use dev ACR secrets (if they exist, otherwise fallback to prod)
      SERVER="${{ secrets.ACR_LOGIN_SERVER_DEV }}"
      if [[ -z "$SERVER" ]]; then SERVER="${{ secrets.ACR_LOGIN_SERVER }}"; fi
      echo "server=${SERVER}" >> $GITHUB_OUTPUT
      # ... complex fallback logic for all secrets ...
    fi
```

**After**:
```yaml
- name: Determine ACR based on branch
  id: set_acr
  run: |
    if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
      # Production: use prod ACR secrets
      echo "server=${{ secrets.ACR_LOGIN_SERVER_PROD }}" >> $GITHUB_OUTPUT
      echo "name=${{ secrets.ACR_NAME_PROD }}" >> $GITHUB_OUTPUT
      echo "username=${{ secrets.ACR_USERNAME_PROD }}" >> $GITHUB_OUTPUT
      echo "password=${{ secrets.ACR_PASSWORD_PROD }}" >> $GITHUB_OUTPUT
      echo "Using production ACR: ${{ secrets.ACR_LOGIN_SERVER_PROD }}"
    else
      # Development: use dev ACR secrets
      echo "server=${{ secrets.ACR_LOGIN_SERVER_DEV }}" >> $GITHUB_OUTPUT
      echo "name=${{ secrets.ACR_NAME_DEV }}" >> $GITHUB_OUTPUT
      echo "username=${{ secrets.ACR_USERNAME_DEV }}" >> $GITHUB_OUTPUT
      echo "password=${{ secrets.ACR_PASSWORD_DEV }}" >> $GITHUB_OUTPUT
      echo "Using development ACR: ${{ secrets.ACR_LOGIN_SERVER_DEV }}"
    fi
```

**Impact**:
- ‚úÖ Removed complex fallback logic
- ‚úÖ Clear, explicit secret requirements
- ‚úÖ Will fail fast if secrets are missing (better than silent fallback)

##### Change B: Standardized Dev Deployment ACR Name

**Before**:
```yaml
acrName: ${{ secrets.ACR_NAME }}
```

**After**:
```yaml
acrName: ${{ secrets.ACR_NAME_DEV }}
```

**Impact**: Consistent `_DEV` suffix for all development secrets

##### Change C: Removed Hardcoded Container App Name

**Before**:
```yaml
az containerapp update \
  --name app-in-magictoolbox-prod-01 \
  --resource-group ${{ secrets.RESOURCE_GROUP_PROD }} \
  # ...

az containerapp show \
  --name app-in-magictoolbox-prod-01 \
  --resource-group ${{ secrets.RESOURCE_GROUP_PROD }} \
```

**After**:
```yaml
az containerapp update \
  --name ${{ secrets.CONTAINER_APP_NAME_PROD }} \
  --resource-group ${{ secrets.RESOURCE_GROUP_PROD }} \
  # ...

az containerapp show \
  --name ${{ secrets.CONTAINER_APP_NAME_PROD }} \
  --resource-group ${{ secrets.RESOURCE_GROUP_PROD }} \
```

**Impact**: 
- ‚úÖ No hardcoded resource names in workflows
- ‚úÖ Easier to deploy to different environments
- ‚úÖ Consistent with other resource references

---

#### 3. `.github/workflows/deploy-infrastructure.yml`

**Change**: Removed unused environment variable

**Before**:
```yaml
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Set environment variables
    run: |
      ENV_UPPER=$(echo "${{ github.event.inputs.environment }}" | tr '[:lower:]' '[:upper:]')
      echo "ENV_UPPER=$ENV_UPPER" >> $GITHUB_ENV
  
  - name: Set deployment environment
    # ...
```

**After**:
```yaml
steps:
  - name: Checkout code
    uses: actions/checkout@v4
  
  - name: Set deployment environment
    # ...
```

**Impact**: Removed dead code that was never referenced

---

## Required GitHub Secrets

### ‚ö†Ô∏è Action Required: Add Missing Secrets

To support the standardized workflow, ensure these secrets exist in your GitHub repository:

#### Development Environment Secrets
- ‚úÖ `AZURE_CREDENTIALS_DEV`
- ‚úÖ `RESOURCE_GROUP_DEV`
- ‚ö†Ô∏è `ACR_LOGIN_SERVER_DEV` (new/update)
- ‚ö†Ô∏è `ACR_NAME_DEV` (new/update)
- ‚ö†Ô∏è `ACR_USERNAME_DEV` (new/update)
- ‚ö†Ô∏è `ACR_PASSWORD_DEV` (new/update)
- ‚úÖ `CONTAINER_APP_NAME_DEV`

#### Production Environment Secrets
- ‚úÖ `AZURE_CREDENTIALS_PROD`
- ‚úÖ `RESOURCE_GROUP_PROD`
- ‚úÖ `ACR_LOGIN_SERVER_PROD`
- ‚úÖ `ACR_NAME_PROD`
- ‚úÖ `ACR_USERNAME_PROD`
- ‚úÖ `ACR_PASSWORD_PROD`
- ‚ö†Ô∏è `CONTAINER_APP_NAME_PROD` (new - was hardcoded before)

### How to Get Values

```bash
# Container App Name (Production)
az containerapp list \
  --resource-group $RESOURCE_GROUP_PROD \
  --query "[0].name" -o tsv

# ACR values (Development)
az acr list \
  --resource-group $RESOURCE_GROUP_DEV \
  --query "[0].{name:name, loginServer:loginServer}" -o json

# ACR credentials (Development)
az acr credential show \
  --name <acr-name-dev> \
  --query "{username:username, password:passwords[0].value}" -o json
```

---

## Workflow Structure (After Cleanup)

### Remaining Workflows (4)

1. **`azure-deploy.yml`** - Primary deployment workflow
   - Triggers: Push to main/develop, manual dispatch
   - Jobs: Semantic release, build Docker image, deploy to dev/prod
   - Handles: Complete CI/CD pipeline

2. **`deploy-function-app.yml`** - Azure Function deployment
   - Triggers: Push to develop/main (when function_app/ changes), manual dispatch
   - Jobs: Deploy function app to dev/prod with dependencies
   - Handles: Serverless function deployments

3. **`deploy-infrastructure.yml`** - Infrastructure as Code
   - Triggers: Manual dispatch, push to main/develop (when infra/ changes)
   - Jobs: Deploy/destroy Bicep infrastructure
   - Handles: Azure resource provisioning

4. **`e2e-tests.yml`** - End-to-end testing
   - Triggers: Manual dispatch only
   - Jobs: Run E2E tests, cleanup test data
   - Handles: Integration testing against Azure environments

---

## Deployment Flow

### Development Branch (`develop`)
```
Push to develop
  ‚Üì
azure-deploy.yml triggers
  ‚Üì
1. Build Docker image (tag: develop-<sha>)
2. Push to ACR_DEV
3. Deploy to Container App (dev environment)
  ‚Üì
If function_app/ changed:
  deploy-function-app.yml also triggers
    ‚Üì
  Deploy functions to dev environment
```

### Production Branch (`main`)
```
Push to main (with conventional commits)
  ‚Üì
azure-deploy.yml triggers
  ‚Üì
1. Semantic Release (creates version tag)
2. Build Docker image (tag: <version> + latest)
3. Push to ACR_PROD
4. Deploy to Container App (prod environment)
  ‚Üì
If function_app/ changed:
  deploy-function-app.yml also triggers
    ‚Üì
  Deploy functions to prod environment
```

---

## Benefits of Changes

### üéØ Improved Reliability
- No missing dependencies in production function deployments
- Fail-fast approach when secrets are misconfigured
- Consistent packaging between environments

### üßπ Reduced Complexity
- Removed 2 redundant workflow files
- Eliminated complex fallback logic
- Single source of truth for each workflow

### üîí Better Security
- No hardcoded resource names
- All configuration via GitHub secrets
- Clear audit trail of what secrets are required

### üìä Easier Maintenance
- Standardized naming convention (`_DEV` / `_PROD`)
- Self-documenting secret requirements
- Consistent patterns across all workflows

---

## Testing Recommendations

Before pushing to production:

1. **Verify secrets exist**:
   ```bash
   # Check in GitHub UI: Settings ‚Üí Secrets and variables ‚Üí Actions
   # Ensure all secrets listed above are present
   ```

2. **Test development deployment**:
   - Push to `develop` branch
   - Monitor `azure-deploy.yml` workflow
   - Verify container app deploys successfully

3. **Test function deployment**:
   - Make a change in `function_app/`
   - Push to `develop` branch
   - Monitor `deploy-function-app.yml` workflow
   - Verify functions deploy with dependencies

4. **Test production deployment** (use workflow_dispatch first):
   - Go to Actions ‚Üí Release and Deploy
   - Click "Run workflow"
   - Select `prod` environment
   - Monitor deployment

---

## Rollback Plan

If issues occur after these changes:

```bash
# Revert the cleanup commit
git revert <commit-hash>
git push origin develop

# Or restore specific files from history
git checkout <previous-commit> -- .github/workflows/
git commit -m "chore: rollback workflow changes"
git push origin develop
```

**Note**: The deleted workflows (`release.yml`, `develop_func-...yml`) are still in git history and can be restored if absolutely necessary.

---

## Future Improvements (Not Implemented Yet)

### Medium Priority
1. Add timeout/automatic restore for network security toggles in E2E tests
2. Replace hardcoded sleep commands with polling mechanisms
3. Add workflow descriptions at the top of each file

### Low Priority  
4. Add unit/integration tests to CI pipeline
5. Add Python linting (ruff, black, isort) to CI
6. Add security scanning (Trivy, Snyk, CodeQL)
7. Configure Dependabot for dependency updates
8. Consider multi-platform Docker builds (currently only linux/amd64)

---

## Related Documentation

- [GitHub Secrets Setup](GITHUB_SECRETS_SETUP.md)
- [Azure Deployment Guide](AZURE_DEPLOYMENT_README.md)
- [Conventional Commits](CONVENTIONAL_COMMITS.md)

---

## Changelog Entry

```markdown
## [Unreleased]

### Changed
- Standardized GitHub Actions workflows with consistent secret naming (_DEV/_PROD suffixes)
- Fixed production Azure Function deployment to include dependencies
- Removed hardcoded resource names in azure-deploy.yml workflow

### Removed
- Deleted redundant release.yml workflow (functionality integrated into azure-deploy.yml)
- Deleted obsolete develop_func-magictoolbox-dev-rze6cb73hmijy.yml workflow
- Removed unused ENV_UPPER variable in deploy-infrastructure.yml
```
